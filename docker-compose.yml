version: "3"

services:

  # Proxy and web page

  proxy:
    container_name: proxy
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./cert/conf:/etc/letsencrypt
      - ./cert/www:/var/www/certbot
    depends_on:
      - cloud

  cert:
    container_name: cert
    restart: unless-stopped
    image: certbot/certbot
    volumes:
      - ./cert/conf:/etc/letsencrypt
      - ./cert/www:/var/www/certbot
    #command: certonly --webroot -w /var/www/certbot --email valentin.schaar@web.de -d valentin-schaar.de -d www.valentin-schaar.de -d cloud.valentin-schaar.de -d remote.valentin-schaar.de --agree-tos #--force-renewal
    command: renew

  # Cloud storage

  cloud:
    container_name: cloud
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.cloud
    volumes:
      - cloud_data:/var/www/html
    depends_on:
      - cloud_db

  cloud_db:
    container_name: cloud_db
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.cloud_db
    volumes:
        - cloud_db_data:/var/lib/mysql

volumes:
  cert_conf_data:
  cert_www_data:
  cloud_data:
  cloud_db_data:
